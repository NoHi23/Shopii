{"ast":null,"code":"// paymentSlice.js\nimport { createAsyncThunk, createSlice } from '@reduxjs/toolkit';\nimport axios from 'axios';\nconst API_URL = process.env.REACT_APP_API_URL || 'http://localhost:9999/api';\nexport const createPayment = createAsyncThunk('payment/createPayment', async (paymentData, _ref) => {\n  let {\n    getState,\n    rejectWithValue\n  } = _ref;\n  try {\n    const token = getState().auth.token;\n    if (!token) {\n      return rejectWithValue('No token found');\n    }\n\n    // Validate orderId is present\n    if (!paymentData.orderId) {\n      console.error('Missing orderId in payment data:', paymentData);\n      return rejectWithValue('Missing order ID. Please try again.');\n    }\n\n    // Ensure orderId is a string\n    const sanitizedData = {\n      ...paymentData,\n      orderId: String(paymentData.orderId),\n      replaceExisting: paymentData.replaceExisting || false // Add flag to indicate if previous payment should be deleted\n    };\n\n    console.log('Creating payment with data:', sanitizedData);\n    const response = await axios.post(`${API_URL}/buyers/payments`, sanitizedData, {\n      headers: {\n        Authorization: `Bearer ${token}`\n      }\n    });\n\n    // Add extra validation to ensure we have required fields based on payment method\n    const data = response.data;\n    if (paymentData.method === 'VietQR' && (!data.qrData || !data.qrData.qrDataURL)) {\n      console.error('VietQR API response missing qrData or qrDataURL:', data);\n      return rejectWithValue('QR code generation failed. Please try another payment method.');\n    }\n    if (paymentData.method === 'PayOS' && !data.paymentUrl) {\n      console.error('PayOS API response missing paymentUrl:', data);\n      return rejectWithValue('Payment URL generation failed. Please try another payment method.');\n    }\n    return data;\n  } catch (error) {\n    var _error$response, _error$response$data, _error$response2, _error$response2$data;\n    console.error('Payment creation error:', error);\n    return rejectWithValue(((_error$response = error.response) === null || _error$response === void 0 ? void 0 : (_error$response$data = _error$response.data) === null || _error$response$data === void 0 ? void 0 : _error$response$data.message) || ((_error$response2 = error.response) === null || _error$response2 === void 0 ? void 0 : (_error$response2$data = _error$response2.data) === null || _error$response2$data === void 0 ? void 0 : _error$response2$data.details) || 'Failed to create payment. Please try again.');\n  }\n});\n\n// Thêm hàm kiểm tra trạng thái thanh toán\nexport const checkPaymentStatus = createAsyncThunk('payment/checkPaymentStatus', async (orderId, _ref2) => {\n  let {\n    getState,\n    rejectWithValue\n  } = _ref2;\n  try {\n    const token = getState().auth.token;\n    if (!token) {\n      return rejectWithValue('No token found');\n    }\n    const response = await axios.get(`${API_URL}/buyers/payments/status/${orderId}`, {\n      headers: {\n        Authorization: `Bearer ${token}`\n      }\n    });\n    return response.data;\n  } catch (error) {\n    var _error$response3, _error$response3$data;\n    console.error('Payment status check error:', error);\n    return rejectWithValue(((_error$response3 = error.response) === null || _error$response3 === void 0 ? void 0 : (_error$response3$data = _error$response3.data) === null || _error$response3$data === void 0 ? void 0 : _error$response3$data.message) || 'Failed to check payment status.');\n  }\n});\nconst paymentSlice = createSlice({\n  name: 'payment',\n  initialState: {\n    payment: null,\n    paymentStatus: null,\n    loading: false,\n    statusChecking: false,\n    error: null,\n    success: false\n  },\n  reducers: {\n    resetPayment: state => {\n      state.payment = null;\n      state.paymentStatus = null;\n      state.success = false;\n      state.error = null;\n    },\n    cancelPaymentPolling: state => {\n      // This action is specifically for canceling the polling process\n      // It can be called when navigating away from payment pages\n      state.statusChecking = false;\n      // Also reset any related data to prevent callback issues\n      state.paymentStatus = null;\n      state.loading = false;\n      // Don't reset other data in case we want to keep payment information\n    }\n  },\n\n  extraReducers: builder => {\n    builder.addCase(createPayment.pending, state => {\n      state.loading = true;\n      state.error = null;\n      state.success = false;\n    }).addCase(createPayment.fulfilled, (state, action) => {\n      state.loading = false;\n      state.payment = action.payload;\n      state.success = true;\n    }).addCase(createPayment.rejected, (state, action) => {\n      state.loading = false;\n      state.error = action.payload;\n      state.success = false;\n    })\n    // Thêm reducers cho checkPaymentStatus\n    .addCase(checkPaymentStatus.pending, state => {\n      state.statusChecking = true;\n    }).addCase(checkPaymentStatus.fulfilled, (state, action) => {\n      state.statusChecking = false;\n      state.paymentStatus = action.payload;\n    }).addCase(checkPaymentStatus.rejected, state => {\n      state.statusChecking = false;\n    });\n  }\n});\nexport const {\n  resetPayment,\n  cancelPaymentPolling\n} = paymentSlice.actions;\nexport default paymentSlice.reducer;","map":{"version":3,"names":["createAsyncThunk","createSlice","axios","API_URL","process","env","REACT_APP_API_URL","createPayment","paymentData","getState","rejectWithValue","token","auth","orderId","console","error","sanitizedData","String","replaceExisting","log","response","post","headers","Authorization","data","method","qrData","qrDataURL","paymentUrl","message","details","checkPaymentStatus","get","paymentSlice","name","initialState","payment","paymentStatus","loading","statusChecking","success","reducers","resetPayment","state","cancelPaymentPolling","extraReducers","builder","addCase","pending","fulfilled","action","payload","rejected","actions","reducer"],"sources":["D:/SU25/SDN302 - HOANNN/Shopii-Template/front-end/src/features/payment/paymentSlice.js"],"sourcesContent":["// paymentSlice.js\nimport { createAsyncThunk, createSlice } from '@reduxjs/toolkit';\nimport axios from 'axios';\n\nconst API_URL = process.env.REACT_APP_API_URL || 'http://localhost:9999/api';\n\nexport const createPayment = createAsyncThunk(\n  'payment/createPayment',\n  async (paymentData, { getState, rejectWithValue }) => {\n    try {\n      const token = getState().auth.token;\n      if (!token) {\n        return rejectWithValue('No token found');\n      }\n\n      // Validate orderId is present\n      if (!paymentData.orderId) {\n        console.error('Missing orderId in payment data:', paymentData);\n        return rejectWithValue('Missing order ID. Please try again.');\n      }\n\n      // Ensure orderId is a string\n      const sanitizedData = {\n        ...paymentData,\n        orderId: String(paymentData.orderId),\n        replaceExisting: paymentData.replaceExisting || false // Add flag to indicate if previous payment should be deleted\n      };\n      \n      console.log('Creating payment with data:', sanitizedData);\n      \n      const response = await axios.post(`${API_URL}/buyers/payments`, sanitizedData, {\n        headers: { Authorization: `Bearer ${token}` },\n      });\n      \n      // Add extra validation to ensure we have required fields based on payment method\n      const data = response.data;\n      \n      if (paymentData.method === 'VietQR' && (!data.qrData || !data.qrData.qrDataURL)) {\n        console.error('VietQR API response missing qrData or qrDataURL:', data);\n        return rejectWithValue('QR code generation failed. Please try another payment method.');\n      }\n      \n      if (paymentData.method === 'PayOS' && !data.paymentUrl) {\n        console.error('PayOS API response missing paymentUrl:', data);\n        return rejectWithValue('Payment URL generation failed. Please try another payment method.');\n      }\n      \n      return data;\n    } catch (error) {\n      console.error('Payment creation error:', error);\n      return rejectWithValue(\n        error.response?.data?.message || \n        error.response?.data?.details || \n        'Failed to create payment. Please try again.'\n      );\n    }\n  }\n);\n\n// Thêm hàm kiểm tra trạng thái thanh toán\nexport const checkPaymentStatus = createAsyncThunk(\n  'payment/checkPaymentStatus',\n  async (orderId, { getState, rejectWithValue }) => {\n    try {\n      const token = getState().auth.token;\n      if (!token) {\n        return rejectWithValue('No token found');\n      }\n      \n      const response = await axios.get(`${API_URL}/buyers/payments/status/${orderId}`, {\n        headers: { Authorization: `Bearer ${token}` }\n      });\n      \n      return response.data;\n    } catch (error) {\n      console.error('Payment status check error:', error);\n      return rejectWithValue(\n        error.response?.data?.message || \n        'Failed to check payment status.'\n      );\n    }\n  }\n);\n\nconst paymentSlice = createSlice({\n  name: 'payment',\n  initialState: {\n    payment: null,\n    paymentStatus: null,\n    loading: false,\n    statusChecking: false,\n    error: null,\n    success: false,\n  },\n  reducers: {\n    resetPayment: (state) => {\n      state.payment = null;\n      state.paymentStatus = null;\n      state.success = false;\n      state.error = null;\n    },\n    cancelPaymentPolling: (state) => {\n      // This action is specifically for canceling the polling process\n      // It can be called when navigating away from payment pages\n      state.statusChecking = false;\n      // Also reset any related data to prevent callback issues\n      state.paymentStatus = null;\n      state.loading = false;\n      // Don't reset other data in case we want to keep payment information\n    },\n  },\n  extraReducers: (builder) => {\n    builder\n      .addCase(createPayment.pending, (state) => {\n        state.loading = true;\n        state.error = null;\n        state.success = false;\n      })\n      .addCase(createPayment.fulfilled, (state, action) => {\n        state.loading = false;\n        state.payment = action.payload;\n        state.success = true;\n      })\n      .addCase(createPayment.rejected, (state, action) => {\n        state.loading = false;\n        state.error = action.payload;\n        state.success = false;\n      })\n      // Thêm reducers cho checkPaymentStatus\n      .addCase(checkPaymentStatus.pending, (state) => {\n        state.statusChecking = true;\n      })\n      .addCase(checkPaymentStatus.fulfilled, (state, action) => {\n        state.statusChecking = false;\n        state.paymentStatus = action.payload;\n      })\n      .addCase(checkPaymentStatus.rejected, (state) => {\n        state.statusChecking = false;\n      });\n  },\n});\n\nexport const { resetPayment, cancelPaymentPolling } = paymentSlice.actions;\nexport default paymentSlice.reducer;"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}